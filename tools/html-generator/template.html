<!doctype html>
<html>

<head>
  <meta charset="utf-8">
  <title>{ app_name }</title>
</head>

<body>
  <script type="module">
    import { mach } from "./mach.js";
    import { sysjs } from "./mach-sysjs.js";
    import { sysaudio } from "./mach-sysaudio.js";
    import setupWasmserve from "./wasmserve.js";

    setupWasmserve();

    let imports = {
      mach,
      sysjs,
      sysaudio,
      env: {
        memory: new WebAssembly.Memory({
          initial: 20,
          maximum: 100,
          shared: true,
        })
      },
    };
    

    WebAssembly.instantiateStreaming(fetch("{ app_name }.wasm"), imports)
      .then(async ({ instance, module }) => {
        // must be called first until the module is split to not overwrite memory
        await sysaudio.init(module, imports.env.memory);

        sysjs.init(instance, imports.env.memory);
        mach.init(instance, imports.env.memory);
        instance.exports.wasmInit();
        console.trace("init finished");

        window.getWasmString = mach.getString;

        let frame = true;
        let last_update_time = performance.now();
        let update = function () {
          if (!frame) return;
          if (mach.machHasEvent() ||
            (last_update_time + (mach.wait_event_timeout * 1000)) <= performance.now()) {
            instance.exports.wasmUpdate();
            last_update_time = performance.now();
          }
          window.requestAnimationFrame(update);
        };

        window.requestAnimationFrame(update);

        window.addEventListener("mach-close", () => {
          instance.exports.wasmDeinit();
          frame = false;
        });
      })
      .catch(err => console.error(err));
  </script>
</body>

</html>